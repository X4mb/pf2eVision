# Foundry Virtual Tabletop v13 Module Development Rules

This project is a **Foundry Virtual Tabletop (Foundry VTT) version 13 module**. All development must follow Foundry VTT v13 API conventions and best practices.

## API Documentation Reference

- **Primary API Documentation**: https://foundryvtt.com/api/
- **Version**: Foundry VTT v13.350+ (Stable)
- **API Type**: Public API only - avoid using private API methods (marked with `@private`, `@internal`, or prefixed with `_`)

## Module Structure

### Core Files
- `module.json` - Module manifest (required)
- `scripts/` - JavaScript/ESM modules
- `styles/` - CSS stylesheets
- `lang/` - Internationalization JSON files
- `templates/` - Handlebars templates (if needed)

### Module Manifest (`module.json`)
- MUST specify `"type": "module"` for v13
- MUST include `"compatibility.minimum": "13"` and `"compatibility.verified": "13"`
- MUST use `"esmodules"` array for script entries (ES6 modules)
- All paths in manifest should be relative to module root

## Foundry VTT API Usage Guidelines

### Public API Only
- **USE**: Methods marked with `@public` annotation
- **AVOID**: Methods prefixed with `_` (private), `@private`, `@internal`, or `#` (truly private)
- **OVERRIDE**: `@protected` methods only when extending core classes

### Hooks System
- Use `Hooks.on()` for event subscriptions
- Use `Hooks.once()` for one-time initialization
- Use `Hooks.call()` / `Hooks.callAll()` for custom hooks
- Always clean up hooks when module is disabled (if needed)
- Reference: `foundry.helpers.Hooks`

### Document Management
- Use Document API for Actor, Token, Scene, Item operations
- Prefer `Document.create()`, `Document.update()`, `Document.delete()` over direct database operations
- Use `foundry.documents.*` classes (Actor, Token, Scene, Item, etc.)
- Store custom data using `Document.flags` (e.g., `token.getFlag('module-id', 'flag-key')`)

### Settings Registration
- Use `game.settings.register()` for module settings
- Scope appropriately: `'world'` for world-wide settings, `'client'` for per-user settings
- Always use `game.i18n.localize()` for translatable strings
- Reference: Settings should be registered during module initialization

### Internationalization (i18n)
- Store all user-facing strings in `lang/en.json`
- Use `game.i18n.localize('MODULE_KEY.SUBKEY')` for translations
- Structure JSON with nested objects (e.g., `MODULE_KEY.SECTION.ITEM`)
- Always provide English (`en`) as the base language

### Canvas and Token Interaction
- Access canvas via `canvas` (global)
- Token layer: `canvas.layers.TokenLayer`
- Token documents: `foundry.documents.BaseToken` or `foundry.canvas.placeables.Token`
- Use token flags for custom data: `token.getFlag()`, `token.setFlag()`, `token.unsetFlag()`
- Vision-related: Use `token.vision` object for vision configuration

### Application Development
- Use `ApplicationV2` for modern applications (v13)
- Use `DocumentSheetV2` for document sheets (v13)
- Use `DialogV2` for dialogs (v13)
- Legacy `Application` classes still work but prefer V2 versions

### Module Initialization
- Initialize using `Hooks.once('ready', callback)` when game is fully loaded
- Access global `game` object only after `ready` hook fires
- Initialize settings, hooks, and other module features in initialization

### Best Practices

1. **Error Handling**
   - Always use try-catch blocks for async operations
   - Log errors with `console.error()` or `ui.notifications.error()`
   - Provide user-friendly error messages

2. **Performance**
   - Minimize DOM queries and cache references
   - Use debouncing for frequent updates
   - Avoid blocking operations in hooks

3. **Compatibility**
   - Test with core Foundry v13
   - Test with common game systems (especially PF2e if applicable)
   - Avoid conflicts with other modules by using unique flag namespaces

4. **Code Style**
   - Use ES6+ features (modules, async/await, arrow functions)
   - Use JSDoc comments for public methods
   - Follow Foundry's naming conventions

5. **Data Storage**
   - Store module data in Document flags: `document.flags['module-id']`
   - Use structured objects for complex data
   - Validate data before storing

6. **UI/UX**
   - Follow Foundry's UI patterns
   - Use Foundry's form styling classes
   - Ensure accessibility (keyboard navigation, screen readers)

## Module-Specific Context

This module (`pf2e-vision-config`) extends token vision configuration for Pathfinder 2e:
- Extends token configuration UI
- Manages vision ranges in feet and miles
- Supports multiple vision types (normal, low-light, darkvision, blindsight, tremorsense)
- Integrates with Foundry's vision and lighting system

## Development Workflow

1. **Code Changes**: Update files in `scripts/`, `styles/`, `lang/` as needed
2. **Testing**: Test in Foundry VTT v13 environment
3. **Version Bump**: **CRITICAL** - Always update version in `module.json` following semantic versioning (e.g., "0.0.2" -> "0.0.3"). Foundry VTT checks the version to determine if a module update is available when checking GitHub manifests. Without a version bump, users won't see updates.
4. **Documentation**: Update README.md with changes
5. **Git Commit**: After version bump and code changes, commit and push to repository

## Common Patterns

### Hook Example
```javascript
Hooks.on('renderTokenConfig', (app, html, data) => {
    // Module logic here
});
```

### Settings Example
```javascript
game.settings.register('pf2e-vision-config', 'settingKey', {
    name: game.i18n.localize('MODULE.SETTING.NAME'),
    hint: game.i18n.localize('MODULE.SETTING.HINT'),
    scope: 'world',
    config: true,
    type: String,
    default: 'defaultValue'
});
```

### Flag Example
```javascript
// Get flag
const value = token.getFlag('pf2e-vision-config', 'flagKey');

// Set flag
await token.setFlag('pf2e-vision-config', 'flagKey', value);
```

## References

- Foundry VTT API: https://foundryvtt.com/api/
- Foundry Discord: For support and community assistance
- Foundry Documentation: Check source code in Foundry installation (`resources/app/client/` and `resources/app/common/`)

